---
title: "Air BnB Data Analysis"
author: Shravani Samala
date: "4/2/2020 "
output: html_document
---

```{r, message=F, warning=F}
# front-matter
rm(list = ls()) #clear the workspace

library(ggplot2)
library(ggformula)
library(corrplot)
library(dplyr)
library(lmerTest)
library(lme4)
library(knitr)
library(tidyverse)
library(readr)
library(mosaic)
library(data.table)
library(VGAM)
library(lmtest)

```
# Introduction

Variables included in data: 
*overall_satisfaction = rating on a 0-5 scale.
*price = price for one night (in dollars)
*reviews = number of reviews posted
*room_type = Entire home/apt, Private room, or Shared room
*accommodates = number of people the unit can hold
*bedrooms = number of bedrooms
*minstay = minimum length of stay (in days)
*neighborhood = neighborhood where unit is located (1 of 43)
*district = district where unit is located (1 of 9)
*WalkScore = quality of the neighborhood for walking (0-100)
*TransitScore = quality of the neighborhood for public transit (0-100)
*BikeScore = quality of the neighborhood for biking (0-100)
*PctBlack = proportion of black residents in a neighborhood

Variables created: 
*satisfaction = 1 if overall_satisfaction is 5, 0 otherwise
*priceHigh = 1 if price is greater than or equal to 120, 0 otherwise
*entire = 1 if room_type is Entire home/apt, 0 otherwise
*private = 1 if room_type is Private room, 0 otherwise
*shared = 1 if room_type is Shared room, 0 otherwise
*HighBlack = 1 if PctBlack above .60, 0 otherwise
*HighRev = 1 if unit has more than 100 reviews posted, 0 otherwise

```{r}
myFile2 <- "https://raw.githubusercontent.com/proback/BYSH/master/data/airbnb.csv"
AirBnb.data <- read_csv(myFile2)

head(AirBnb.data)
```


```{r}
AirBnb.data<-
AirBnb.data%>%
  rename(ID = X1)%>%
  mutate(priceHigh = factor(ifelse(price >= 120,1,0)), # 1 means high price, 0 means low price
        satisfaction = factor(ifelse(overall_satisfaction == 5.0, 1, 0)),
        entire = factor(ifelse(room_type == "Entire home/apt", 1, 0)), 
        private = factor(ifelse(room_type == "Private room", 1, 0)),
        shared = factor(ifelse(room_type == "Shared room", 1, 0)),
        HighBlack = factor(ifelse(PctBlack > 0.60, 1, 0)),
        HighRev= factor(ifelse(reviews >= 100, 1, 0)))


head(AirBnb.data)
glimpse(AirBnb.data)

```

# Research Question 1: What variables contribute to a customer's complete satisfaction with a hotel? 
### EDA
As seen in the summary statistics, the mean bedrooms, number for people the unit accommodates, price, Walk score, Transit score, and Bike Score for being completely satisfied (satisfaction = 1) and not completely satsified (satisfaction = 0) are all very similar. The only one that looks significantly different is the price of the unit. After looking at the boxplots, the means for bedrooms, transit score, and bike score appear to be very similar and the means for number of people the unit accommodates, price, and walk score look different. Therefore, I will fit a logistic model to each of these variables to see if they are significant in predicting the odds of whether of not a customer is completely satisfied. 
```{r}
AirBnb.data %>%
  group_by(satisfaction) %>%
  summarise(mean(bedrooms), 
            mean(accommodates), 
            mean(price), 
            mean(minstay), 
            mean(WalkScore), 
            mean(TransitScore), 
            mean(BikeScore))

ggplot(AirBnb.data, aes(x = satisfaction, y = bedrooms)) + geom_boxplot(color = "black") + coord_flip()
ggplot(AirBnb.data, aes(x = satisfaction, y = accommodates)) + geom_boxplot(color = "black") + coord_flip()
ggplot(AirBnb.data, aes(x = satisfaction, y = price)) + geom_boxplot(color = "black") + coord_flip()
ggplot(AirBnb.data, aes(x = satisfaction, y = minstay)) + geom_boxplot(color = "black") + coord_flip()
ggplot(AirBnb.data, aes(x = satisfaction, y = WalkScore)) + geom_boxplot(color = "black") + coord_flip()
ggplot(AirBnb.data, aes(x = satisfaction, y = TransitScore)) + geom_boxplot(color = "black") + coord_flip()
ggplot(AirBnb.data, aes(x = satisfaction, y = BikeScore)) + geom_boxplot(color = "black") + coord_flip()


```

### Fitting the Models for Research Question 1
* First I tested each variable (bedrooms, accommodates, price, minstay, WalkScore, TransitScore and BikeScore) to see if they were significant in predicting the odds that a customer is satisfied with their stay at their hotel. After fitting each model, it appeared that the significant variables were accommodates, price and WalkScore. Then, I decided to create a full model which would contain the additive model of the significant variables as well as their interactions. After the backwards elimination process, the full final model turned out to be: 

\[log(pi/(1−pi)) = \beta_0 + \beta_1(accommodates) + \beta_2(price) + \beta_3(WalkScore) + \beta_4(accommodates*WalkScore) + \beta_5(price*WalkScore)\]

```{r}

# Bedtooms
bedModel <- glm(satisfaction ~ bedrooms, family = "binomial", data = AirBnb.data)
summary(bedModel)

# Accomodations
accModel <- glm(satisfaction ~ accommodates, family = "binomial", data = AirBnb.data)
summary(accModel)

# Price
priceModel <- glm(satisfaction ~ price, family = "binomial", data = AirBnb.data)
summary(priceModel)

# Minimum stay
minstayModel <- glm(satisfaction ~ minstay, family = "binomial", data = AirBnb.data)
summary(minstayModel)

# Walk Score
minstayModel <- glm(satisfaction ~ WalkScore, family = "binomial", data = AirBnb.data)
summary(minstayModel)

# Transit Score
minstayModel <- glm(satisfaction ~ TransitScore, family = "binomial", data = AirBnb.data)
summary(minstayModel)

# Bike Score
minstayModel <- glm(satisfaction ~ BikeScore, family = "binomial", data = AirBnb.data)
summary(minstayModel)

```

```{r}
#Full Model 
fullModel <- glm(satisfaction ~ (accommodates + price + WalkScore)^2, family = "binomial", data = AirBnb.data)

fullFinalModel <- step(fullModel, direction = "backward")
summary(fullFinalModel)
```

* Given that this is a somewhat complicate model with six parameter, two of which include an interaction between two variables, I wanted to test if the additive model would be sufficient in predicting the odds that the customer would be satisfied with their stay. 

* Therefore: 

\[H_0: log(pi/(1−pi)) = \beta_0 + \beta_1(accommodates) + \beta_2(price) + \beta_3(WalkScore)\]
\[H_a: log(pi/(1−pi)) = \beta_0 + \beta_1(accommodates) + \beta_2(price) + \beta_3(WalkScore) + \beta_4(accommodates*WalkScore) + \beta_5(price*WalkScore)\]

* The results of the likelihood ratio test were as follows: 
The LRT test statistic is 10.847 and the p-value is 0.004411. Because the p-value of 0.004411 is less than $\alpha$ = 0.05, we can reject the null and say that the interactions terms are significant in this model and should not be removed. 
```{r}
redFinalModel <- glm(satisfaction ~ accommodates + price + WalkScore, family = "binomial", data = AirBnb.data)

lrtest(fullFinalModel, redFinalModel)
```

* Therefore, the final model remains: 

\[log(pi/(1−pi)) = \beta_0 + \beta_1(accommodates) + \beta_2(price) + \beta_3(WalkScore) + \beta_4(accommodates*WalkScore) + \beta_5(price*WalkScore)\]

* Interpretations: (log odds --> odds($e$ raised to each parameter))
$\beta_0$ = -1.7094179 --> 0.1809711; the estimated odds of being completely satisfied (satisfaction = 1) is 0.1809711.  
$\beta_1$ = -1.0877718 --> 0.3369664; the estimated decrease in odds of the customer being completely satisfied with their stay for every one-unit increase in accommodates is 0.3369664, holding all other variables at a fixed value. 
$\beta_2$ = 0.0592719 --> 1.0610637; the estimated increase in odds of the customer being completely satisfied with their stay for every one-unit increase in price is 1.0610637, holding all other variables at a fixed value.
$\beta_3$ = 0.0268196 --> 1.0285972; the estimated increase in odds of the customer being completely satisfied with their stay for every one-unit increase in WalkScore is 1.0285972, holding all other variables at a fixed value.
$\beta_4$ = 0.0099619 --> 1.0100116; For every one-unit increase in acommodations, the effect of an additional unit of WalkScore will increase the odds of a customer being completely satisfied by 1.0100116. 
$\beta_5$ = -0.0006085 --> 0.9993916; For every one-unit increase in price, the effect of an additional unit of WalkSCore will increase the odds of a customer being completely satisfied by 1.0100116. 

# Research Question 2: When renting an Air BnB, to what extent to the racial composition of the neighborhood, quality of neighborhood for walking, number of people the unit is able to accomodate and number of reviews,  affect the price of the unit you choose?
### EDA
* Level 1 (price) predictors: overall_satisfaction, satisfaction, reviews, room_type, accommodates, bedrooms, minstay
* Level 2 (neighborhood) predictors: district, WalkScore, TransitScore, BikeScore, PctBlack, and HighBlack
* Fixed effects: HighBlack, 
* Random effects: the neighborhood of each Air Bnb

* The summary statistics give show us that variables such as WalkScore, TransitScore, and BikeScore all vary from neighborhood to neighborhood. When testing these variables in the model, we will be able to see how they affect the price of the units. 

* As seen in the dot plots, the overall pattern for each neighborhood appears to be that shared rooms are the lowest in price, private rooms are more expensive than shared rooms, but less expensive that entire homes (which are the most expensive). 

* Furthermore, in all neighborhoods, it seems to be the pattern that if there is a high percentage of blacks in the neighborhood, the price of the unit will be lower than if there were a lower percentage of blacks. 

* There could be a possible neighborhood by HighRev interaction. Some neighborhoods such as West Lawn and Pullman have higher prices for units with a high number of reviews. Other neighborhoods, however, such as Logan Square and Jefferson Park have higher prices for units with less reviews. 
```{r fig.height=10, fig.width=7}

AirBnb.data %>%
  group_by(neighborhood) %>%
  summarise(mean(price),
            mean(WalkScore), 
            mean(TransitScore),
            mean(BikeScore), 
            mean(PctBlack),
            mean(overall_satisfaction), 
            mean(accommodates), 
            mean(bedrooms),
            mean(minstay))


ggplot(data=AirBnb.data, aes(x= entire,y=price)) +  geom_dotplot(binaxis="y") +    coord_flip() + facet_wrap(~neighborhood,ncol=5) + ggtitle("Entire Home vs. Price")

ggplot(data=AirBnb.data, aes(x= private,y=price)) +  geom_dotplot(binaxis="y") +    coord_flip() + facet_wrap(~neighborhood,ncol=5) + ggtitle("Private Room vs. Price")

ggplot(data=AirBnb.data, aes(x= shared,y=price)) +  geom_dotplot(binaxis="y") +    coord_flip() + facet_wrap(~neighborhood,ncol=5) + ggtitle("Shared Room vs. Price")
```
```{r fig.height=10, fig.width=7}
ggplot(data=AirBnb.data, aes(x= room_type,y=price)) +  geom_dotplot(binaxis="y") +    coord_flip() + facet_wrap(~neighborhood,ncol=5) 
```
```{r}
ggplot(data=AirBnb.data, aes(x=HighBlack,y=price)) + 
  geom_boxplot() + coord_flip()
```
```{r fig.height=10, fig.width=7}
ggplot(data=AirBnb.data, aes(x= HighBlack,y=price)) +  geom_dotplot(binaxis="y") +    coord_flip() + facet_wrap(~neighborhood,ncol=5) + ggtitle("HighBlack vs. Price")
```

```{r}
ggplot(data=AirBnb.data, aes(x=HighRev,y=price)) + 
  geom_boxplot() + coord_flip()
```

```{r fig.height=10, fig.width=7}
ggplot(data=AirBnb.data, aes(x= HighRev,y=price)) +  geom_dotplot(binaxis="y") +    coord_flip() + facet_wrap(~neighborhood,ncol=5) + ggtitle("HighBlack vs. Price")
```
### Fitting the Models for Research Question 2
##### Unconditional Means Model to asses amount of variation at each level
* $\alpha_0$ = 97.289
* $\sigma^2_u$ = 1099
* $\sigma^2$ = 6776
* ICC = (1099)/ (1009 + 6776) = 0.1411689
-> 14.12% ot total variability in price of units are attributed to difference among neighborhoods.

```{r}
modelA <- lmer(price ~ 1 + (1|neighborhood), data = AirBnb.data)
summary(modelA)
```


##### Random Sloped and Intercepts Model for level one covariates - HighRev and accommodates
* Level 1: 

\[Y_{ij}=a_i+b_i(HighRev) + c_i(accommodates) + \varepsilon_{ij}\]

* Level 2: 

$a_i=\alpha_0 + u_i$
$b_i=\beta_0 + v_i$
$c_i=\gamma_0 + w_i$

* Composite Model: 

\[Y_{ij} = \alpha_0 + \beta_0(HighRev) + \gamma_0(accommodates) + u_i + v_i(HighREv) + w_i(accommodates) + \varepsilon_{ij}\]

where $\varepsilon_{ij}\sim N(0,\sigma^2)$, $u_i \sim N(0,\sigma^2_u)$, $v_i \sim N(0,\sigma^2_u)$, $w_i \sim N(0,\sigma^2_u)$. 
```{r}
modelB <- lmer(price ~ HighRev + accommodates + (HighRev + accommodates|neighborhood), data = AirBnb.data)
summary(modelB)

```

* $\hat{\alpha}_{0}$ = 29.603; The mean price of an Air Bnb is 29.603.
* $\hat{\beta}_{0}$ = -8.600; The mean decrease in price for units with high reviews is -8.600. 
* $\gamma_1$ = 19.118; The mean increase in price for every one-unit increase in accommodation is 19.138. 
* $\hat{\sigma}_{2u}$= 41.06;  The variance in between-neighborhood deviations in price for units having a high number of reviews is 41.06.
* $\hat{\sigma}_{2v}$= 114.54;  The variance in between-person deviations in price for every increase in accommodations if is 114.54.
* $\hat{\sigma}_2$ = 3641.82, the estimated variance in within neighborhood deviations. 
* $\rho_{uv}$ = 0.-11; the correlation in an Air Bnb's price that has a high number of reviews and their differences in price for ever one-unit increase in accommodations.

##### Adding Level Two Covariates: HighBlack and WalkScore
* Level 1: 

\[Y_{ij}=a_i+b_i(HighRev) + c_i(accommodates) + \varepsilon_{ij}\]

* Level 2: 

$a_i=\alpha_0 + \alpha_1(HighBlack) + \alpha_2(WalkScore) + u_i$
$b_i=\beta_0 + \beta_1(HighBlack) + \beta_2(WalkScore) + v_i$
$c_i=\gamma_0 + \gamma_1(HighBlack) +\gamma_2(WalkScore) + w_i$


* Composite Model: 

\[Y_{ij} = \alpha_0 + \alpha_1(cenMPQ) + beta_0(audInstr) + \beta_1(cenMPQ*audInstr) + \gamma_0(audStud) + \gamma_1(cenMPQ*audStud) u_i + v_i(audInstr) + w_i(audStud) + \varepsilon_{ij}\]

where $\varepsilon_{ij}\sim N(0,\sigma^2)$, $u_i \sim N(0,\sigma^2_u)$, $v_i \sim N(0,\sigma^2_u)$, $w_i \sim N(0,\sigma^2_u)$. 

```{r}
modelC <- lmer(price ~ HighBlack*HighRev + HighBlack*accommodates + WalkScore*HighRev + WalkScore*accommodates + (HighRev + accommodates|neighborhood), data = AirBnb.data)
summary(modelC)
```





```{r}

```




